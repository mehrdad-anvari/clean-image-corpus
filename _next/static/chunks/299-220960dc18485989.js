"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[299],{4383:(e,t,r)=>{async function o(e){let t=document.createElement("canvas");t.width=8,t.height=8;let r=t.getContext("2d");r.drawImage(e,0,0,8,8);let o=r.getImageData(0,0,8,8).data,a=[];for(let e=0;e<64;e++){let t=o[4*e],r=o[4*e+1],n=o[4*e+2];a[e]=.299*t+.587*r+.114*n}let n=a.reduce((e,t)=>e+t,0)/a.length;return a.map(e=>e>=n?"1":"0").join("")}r.d(t,{AK:()=>f,SR:()=>m,kg:()=>g,jo:()=>c,ze:()=>l,lN:()=>i,wZ:()=>u,kP:()=>w});let a=e=>new Promise((t,r)=>{let o=URL.createObjectURL(e),a=new Image;a.onload=()=>{t(a),URL.revokeObjectURL(o)},a.onerror=r,a.src=o}),n="images";async function i(){await new Promise((e,t)=>{let r=indexedDB.deleteDatabase("ImagesDB");r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async function l(e){let t;let r="images",o="images-indexeddb-backup.json",a=await new Promise((e,t)=>{let o=indexedDB.open("ImagesDB",1);o.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains(r)){let e=t.createObjectStore(r,{keyPath:"name"});e.createIndex("name","name"),e.createIndex("width","width"),e.createIndex("height","height"),e.createIndex("format","format"),e.createIndex("createdAt","createdAt"),e.createIndex("modifiedAt","modifiedAt"),e.createIndex("perceptualHash","perceptualHash"),e.createIndex("similarityOrder","similarityOrder")}},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)});try{t=await e.getFileHandle(o,{create:!1});let n=await t.getFile(),i=await n.text(),l=JSON.parse(i);if(!Array.isArray(l))throw Error("Invalid backup format");let s=a.transaction(r,"readwrite"),c=s.objectStore(r);for(let e of l)c.put(e);await new Promise((e,t)=>{s.oncomplete=()=>e(null),s.onerror=()=>t(s.error)}),console.log("IndexedDB loaded from existing backup.")}catch(a){t=await e.getFileHandle(o,{create:!0});let r=await t.createWritable();await r.write("[]"),await r.close(),console.log("No backup found. Created an empty backup file.",a)}return a}function s(e){return new Promise((t,r)=>{let o=URL.createObjectURL(e),a=new Image;a.onload=()=>{t([a.width,a.height,a]),URL.revokeObjectURL(o)},a.onerror=e=>{URL.revokeObjectURL(o),r(e)},a.src=o})}async function c(e,t){let r=[];for await(let[t,n]of e.entries())if("file"===n.kind){let n=await e.getFileHandle(t),i=await n.getFile(),[l,c,d]=await s(i),u=await a(i),w=await o(u);r.push([t,l,c,w])}for(let[e,o,a,n]of r)await new Promise((r,i)=>{let l=t.transaction("images","readwrite").objectStore("images"),s=l.get(e);s.onsuccess=()=>{if(s.result)console.log("Already exists:",e),r();else{var t;let s=(null===(t=e.split(".").pop())||void 0===t?void 0:t.toLowerCase())||"unknown",c=l.add({name:e,format:s,width:o,height:a,createdAt:Date.now(),modifiedAt:Date.now(),perceptualHash:n});c.onsuccess=()=>{console.log("Added:",e),r()},c.onerror=t=>{console.error("Add error for",e,t),i(c.error)}}},s.onerror=t=>{console.error("Get error for",e,t),i(s.error)}});console.log("All new images processed."),await d(t),console.log("order computed")}async function d(e){let t=e.transaction("images","readonly").objectStore("images"),r=function(e){if(0===e.length)return[];let t=new Set,r=[],o=e[0];for(t.add(o.name),r.push(o);r.length<e.length;){let a=null,n=1/0;for(let r of e){if(t.has(r.name))continue;let e=function(e,t){let r=0;for(let o=0;o<e.length;o++)e[o]!==t[o]&&r++;return r}(o.perceptualHash,r.perceptualHash);e<n&&(n=e,a=r)}if(a)t.add(a.name),r.push(a),o=a;else break}return r}(await new Promise((e,r)=>{let o=t.getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>r(o.error)}));for(let t=0;t<r.length;t++){let o=r[t];o.similarityOrder=t,await new Promise((t,r)=>{let a=e.transaction("images","readwrite").objectStore("images").put(o);a.onsuccess=()=>t(),a.onerror=()=>r(a.error)})}}async function u(e,t){let r="images",o=e.transaction(r,"readonly").objectStore(r).getAll(),a=await new Promise((e,t)=>{o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}),n=await t.getFileHandle("images-indexeddb-backup.json",{create:!0}),i=await n.createWritable();await i.write(JSON.stringify(a,null,2)),await i.close(),console.log("Saved ".concat(a.length," records from IndexedDB to backup file."))}async function w(e,t){let r="images",n=new Set;for await(let[l,c]of e.entries()){if("file"===c.kind){if(n.add(l),!await new Promise((e,o)=>{let a=t.transaction(r,"readwrite").objectStore(r).get(l);a.onsuccess=()=>e(!!a.result),a.onerror=()=>o(a.error)}))try{var i;let n=await e.getFileHandle(l),c=await n.getFile(),[d,u,w]=await s(c),g=await a(c),m=await o(g),f=(null===(i=l.split(".").pop())||void 0===i?void 0:i.toLowerCase())||"unknown",h={name:l,format:f,width:d,height:u,createdAt:Date.now(),modifiedAt:Date.now(),perceptualHash:m};console.log(h),await new Promise((e,o)=>{let a=t.transaction(r,"readwrite").objectStore(r).add(h);a.onsuccess=()=>{console.log("Added:",l),e()},a.onerror=()=>o(a.error)})}catch(e){console.error("Error processing image:",l,e)}}}await new Promise((e,o)=>{let a=t.transaction(r,"readwrite").objectStore(r).openCursor();a.onsuccess=t=>{let r=t.target.result;if(!r)return e();let o=r.value;n.has(o.name)||r.delete(),r.continue()},a.onerror=()=>o(a.error)}),await d(t),console.log("order computed"),console.log("Database sync complete.")}async function g(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;if(!e||!t)return[];let a=t.transaction(n,"readonly").objectStore(n),i=[],l=0,s=r;await new Promise((e,t)=>{let n=a.index("similarityOrder").openCursor();n.onerror=()=>{console.error("Error reading images:",n.error),t(n.error)},n.onsuccess=t=>{let a=t.target.result;if(!a||i.length>=o){e();return}if(l<r){l++,a.continue();return}let n=a.value;i.push([s++,n.name,n]),a.continue()}});let c=[];for(let[t,r,o]of i)try{let a=await e.getFileHandle(r),n=await a.getFile(),i=URL.createObjectURL(n);c.push([t,i,o])}catch(e){console.warn("Could not load file for image: ".concat(r))}return c}async function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;if(!e)return;let o=e.transaction(n,"readonly").objectStore(n),a=[],i=0;return await new Promise((e,n)=>{let l=o.index("similarityOrder").openCursor();l.onerror=()=>{console.error("Error reading images:",l.error),n(l.error)},l.onsuccess=o=>{let n=o.target.result;if(!n||a.length>=r){e();return}if(i<t){i++,n.continue();return}a.push(n.value),n.continue()}}),a}async function f(e){let t=e.transaction(n,"readonly").objectStore(n);return new Promise((e,r)=>{let o=t.count();o.onerror=()=>{console.log("Error in counting images",o.error),r(o.error)},o.onsuccess=()=>{e(o.result)}})}},5373:(e,t,r)=>{r.d(t,{B:()=>l,ProjectProvider:()=>i});var o=r(5155),a=r(2115);let n=(0,a.createContext)(void 0);function i(e){let{children:t}=e,[r,i]=(0,a.useState)(null),[l,s]=(0,a.useState)(null),[c,d]=(0,a.useState)(null),[u,w]=(0,a.useState)(null),[g,m]=(0,a.useState)(!1);return(0,o.jsx)(n.Provider,{value:{rootDirHandle:r,setRootDirHandle:i,imagesDirHandle:l,setImagesDirHandle:s,annotationsDirHandle:c,setAnnotationsDirHandle:d,db:u,setDb:w,isReady:g,setIsReady:m},children:t})}function l(){let e=(0,a.useContext)(n);if(!e)throw Error("useProject must be used within a ProjectProvider");return e}}}]);